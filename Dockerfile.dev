# syntax=docker/dockerfile:1.4
# -----------------------------------------
# Full Dev Image: .NET SDK + Node + Angular
# -----------------------------------------
ARG DOTNET_VERSION=10.0
ARG NODE_VERSION=24
ARG ANGULAR_VERSION=20

FROM mcr.microsoft.com/dotnet/sdk:${DOTNET_VERSION}

# Re-declare build args for later use
ARG DOTNET_VERSION
ARG NODE_VERSION
ARG ANGULAR_VERSION

# Basic tools + Node 24 (via NodeSource)
RUN apt-get update \
 && apt-get install -y curl ca-certificates gnupg \
 && curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - \
 && apt-get install -y nodejs \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

# Install pnpm + Angular CLI globally
RUN corepack enable \
 && corepack prepare pnpm@latest --activate \
 && npm install -g @angular/cli@${ANGULAR_VERSION}

# Create non-root dev user (vscode) if not exists
RUN id -u vscode &>/dev/null || useradd -u 1000 -m vscode

# Prepare workspace + VS Code server dir
RUN mkdir -p /workspaces/app \
 && chown -R 1000:1000 /workspaces \
 && mkdir -p /home/vscode/.vscode-server-shared \
 && chown -R 1000:1000 /home/vscode/.vscode-server-shared

# VS Code will install its server here (host-mounted)
ENV VSCODE_SERVER_DIR=/home/vscode/.vscode-server-shared

# Switch to dev user
USER 1000:1000

# Default working directory at repo root
WORKDIR /workspaces/app

# Optional: log tool versions at build time
RUN dotnet --info && node -v && ng version || true

# Keep container alive for dev
CMD ["sleep", "infinity"]
